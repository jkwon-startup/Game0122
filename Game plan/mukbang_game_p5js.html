<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üçî Î®πÎ∞© Í≤åÏûÑ - p5.js</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            background: linear-gradient(135deg, #ff6b6b 0%, #feca57 50%, #48dbfb 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            animation: bgShift 10s ease infinite;
        }
        @keyframes bgShift {
            0%, 100% { background: linear-gradient(135deg, #ff6b6b 0%, #feca57 50%, #48dbfb 100%); }
            50% { background: linear-gradient(135deg, #a55eea 0%, #fd79a8 50%, #fdcb6e 100%); }
        }
        h1 {
            color: white;
            text-shadow: 3px 3px 0px #ff6b6b, 6px 6px 0px #feca57;
            margin-bottom: 10px;
            font-size: 2.5em;
            animation: bounce 1s ease infinite;
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        #game-container {
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 15px 50px rgba(0,0,0,0.4), 0 0 30px rgba(255,255,255,0.3);
            border: 5px solid white;
        }
        .info {
            color: white;
            margin-top: 15px;
            text-align: center;
            background: rgba(255,255,255,0.2);
            padding: 15px 25px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            font-weight: bold;
        }
        .sound-controls {
            position: fixed;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 10px;
            z-index: 1000;
        }
        .sound-btn {
            background: rgba(255,255,255,0.9);
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            transition: transform 0.2s;
        }
        .sound-btn:hover {
            transform: scale(1.1);
        }
        .sound-btn.muted {
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <div class="sound-controls">
        <button class="sound-btn" id="bgmBtn" onclick="toggleBGM()">üéµ</button>
        <button class="sound-btn" id="sfxBtn" onclick="toggleSFX()">üîä</button>
    </div>
    <h1>üçî Î®πÎ∞© Í≤åÏûÑ üçï</h1>
    <div id="game-container"></div>
    <div class="info">
        <p>‚å®Ô∏è Ï°∞Ïûë: ‚Üê ‚Üí Î∞©Ìñ•ÌÇ§ ÎòêÎäî A, D ÌÇ§ | üéµ ÏùåÏïÖ/Ìö®Í≥ºÏùå Î≤ÑÌäºÏúºÎ°ú ON/OFF</p>
    </div>

    <script>
        // ============================================
        // üéÆ Î®πÎ∞© Í≤åÏûÑ (Mukbang Game) - p5.js Î≤ÑÏ†Ñ
        // ‚ú® ÌôîÎ†§Ìïú Í∑∏ÎûòÌîΩ + ÏΩ§Î≥¥ + Î†àÎ≤® + ÏÇ¨Ïö¥Îìú
        // ============================================

        // üîä ÏÇ¨Ïö¥Îìú ÏãúÏä§ÌÖú
        let audioContext;
        let bgmEnabled = true;
        let sfxEnabled = true;
        let bgmOscillator = null;
        let bgmGain = null;
        let bgmPlaying = false;
        let bgmNoteIndex = 0;
        let bgmInterval = null;

        // BGM Î©úÎ°úÎîî (Í∑ÄÏó¨Ïö¥ Í≤åÏûÑ ÏùåÏïÖ)
        const BGM_MELODY = [
            { note: 523.25, duration: 200 }, // C5
            { note: 587.33, duration: 200 }, // D5
            { note: 659.25, duration: 200 }, // E5
            { note: 698.46, duration: 200 }, // F5
            { note: 783.99, duration: 400 }, // G5
            { note: 783.99, duration: 200 }, // G5
            { note: 698.46, duration: 200 }, // F5
            { note: 659.25, duration: 200 }, // E5
            { note: 587.33, duration: 200 }, // D5
            { note: 523.25, duration: 400 }, // C5
            { note: 659.25, duration: 200 }, // E5
            { note: 783.99, duration: 200 }, // G5
            { note: 880.00, duration: 400 }, // A5
            { note: 783.99, duration: 200 }, // G5
            { note: 659.25, duration: 200 }, // E5
            { note: 523.25, duration: 400 }, // C5
        ];

        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
        }

        // Ìö®Í≥ºÏùå Ïû¨ÏÉù Ìï®Ïàò
        function playSound(type) {
            if (!sfxEnabled) return;
            initAudio();

            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            switch(type) {
                case 'eat':
                    // Î®πÎäî ÏÜåÎ¶¨ - Î∞ùÍ≥† ÏßßÏùÄ Ïùå
                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(880, audioContext.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(1320, audioContext.currentTime + 0.1);
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.15);
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.15);
                    break;

                case 'eatBig':
                    // ÌÅ∞ ÏùåÏãù Î®πÎäî ÏÜåÎ¶¨ - Îçî ÌíçÎ∂ÄÌïú Ïùå
                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(440, audioContext.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(880, audioContext.currentTime + 0.1);
                    oscillator.frequency.exponentialRampToValueAtTime(1320, audioContext.currentTime + 0.2);
                    gainNode.gain.setValueAtTime(0.4, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.25);
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.25);
                    break;

                case 'star':
                    // Î≥Ñ Î®πÎäî ÏÜåÎ¶¨ - Î∞òÏßùÏù¥Îäî ÏïÑÎ•¥ÌéòÏßÄÏò§
                    playArpeggio([1047, 1319, 1568, 2093], 0.08, 0.3);
                    break;

                case 'bomb':
                    // Ìè≠ÌÉÑ ÏÜåÎ¶¨ - ÎÇÆÍ≥† Í±∞Ïπú Ïùå
                    oscillator.type = 'sawtooth';
                    oscillator.frequency.setValueAtTime(200, audioContext.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(50, audioContext.currentTime + 0.3);
                    gainNode.gain.setValueAtTime(0.4, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.3);
                    break;

                case 'combo':
                    // ÏΩ§Î≥¥ ÏÜåÎ¶¨ - ÏÉÅÏäπÌïòÎäî Ïùå
                    oscillator.type = 'square';
                    oscillator.frequency.setValueAtTime(523, audioContext.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(1047, audioContext.currentTime + 0.15);
                    gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.2);
                    break;

                case 'levelUp':
                    // Î†àÎ≤®ÏóÖ ÏÜåÎ¶¨ - Ìå°ÌååÎ†à
                    playArpeggio([523, 659, 784, 1047, 1319, 1568], 0.12, 0.35);
                    break;

                case 'gameOver':
                    // Í≤åÏûÑÏò§Î≤Ñ ÏÜåÎ¶¨ - ÌïòÍ∞ïÌïòÎäî Ïùå
                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(440, audioContext.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(220, audioContext.currentTime + 0.3);
                    oscillator.frequency.exponentialRampToValueAtTime(110, audioContext.currentTime + 0.6);
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.8);
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.8);
                    break;

                case 'start':
                    // ÏãúÏûë ÏÜåÎ¶¨ - Î∞ùÏùÄ Ìå°ÌååÎ†à
                    playArpeggio([523, 659, 784, 1047], 0.1, 0.3);
                    break;
            }
        }

        function playArpeggio(notes, interval, volume) {
            notes.forEach((freq, i) => {
                setTimeout(() => {
                    if (!sfxEnabled) return;
                    const osc = audioContext.createOscillator();
                    const gain = audioContext.createGain();
                    osc.connect(gain);
                    gain.connect(audioContext.destination);
                    osc.type = 'sine';
                    osc.frequency.value = freq;
                    gain.gain.setValueAtTime(volume, audioContext.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                    osc.start(audioContext.currentTime);
                    osc.stop(audioContext.currentTime + 0.2);
                }, i * interval * 1000);
            });
        }

        // BGM Ïû¨ÏÉù
        function startBGM() {
            if (!bgmEnabled || bgmPlaying) return;
            initAudio();
            bgmPlaying = true;

            function playBGMNote() {
                if (!bgmPlaying || !bgmEnabled) return;

                const noteData = BGM_MELODY[bgmNoteIndex];
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();

                osc.connect(gain);
                gain.connect(audioContext.destination);

                osc.type = 'sine';
                osc.frequency.value = noteData.note;

                gain.gain.setValueAtTime(0.15, audioContext.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + noteData.duration / 1000);

                osc.start(audioContext.currentTime);
                osc.stop(audioContext.currentTime + noteData.duration / 1000);

                bgmNoteIndex = (bgmNoteIndex + 1) % BGM_MELODY.length;

                bgmInterval = setTimeout(playBGMNote, noteData.duration);
            }

            playBGMNote();
        }

        function stopBGM() {
            bgmPlaying = false;
            if (bgmInterval) {
                clearTimeout(bgmInterval);
                bgmInterval = null;
            }
        }

        function toggleBGM() {
            bgmEnabled = !bgmEnabled;
            document.getElementById('bgmBtn').classList.toggle('muted', !bgmEnabled);
            if (bgmEnabled && gameState === 'playing') {
                startBGM();
            } else {
                stopBGM();
            }
        }

        function toggleSFX() {
            sfxEnabled = !sfxEnabled;
            document.getElementById('sfxBtn').classList.toggle('muted', !sfxEnabled);
        }

        // üìä Í≤åÏûÑ ÏÑ§Ï†ï ÏÉÅÏàò
        const CANVAS_WIDTH = 400;
        const CANVAS_HEIGHT = 600;
        const PLAYER_SIZE = 70;
        const PLAYER_SPEED = 10;
        const ITEM_SIZE = 50;
        const GAME_TIME = 60;
        const SPAWN_INTERVAL_BASE = 800;

        // üé® Î†àÎ≤®Î≥Ñ Î∞∞Í≤Ω ÏÉâÏÉÅ
        const LEVEL_THEMES = [
            { bg1: '#87CEEB', bg2: '#98D8C8', bg3: '#7FDBFF', ground: '#90EE90', name: 'üå§Ô∏è ÎßëÏùÄ ÌïòÎäò' },
            { bg1: '#FF9A8B', bg2: '#FECDA6', bg3: '#FFD93D', ground: '#F4D03F', name: 'üåÖ ÎÖ∏ÏùÑ ÌïòÎäò' },
            { bg1: '#A855F7', bg2: '#EC4899', bg3: '#8B5CF6', ground: '#C084FC', name: 'üåå Î≥¥ÎùºÎπõ Ïö∞Ï£º' },
            { bg1: '#FF6B6B', bg2: '#4ECDC4', bg3: '#FFE66D', ground: '#95E1D3', name: 'üåà Î¨¥ÏßÄÍ∞ú ÎÇòÎùº' },
            { bg1: '#FFD700', bg2: '#FFA500', bg3: '#FF8C00', ground: '#FFEC8B', name: 'üëë Ìô©Í∏à Ï≤úÍµ≠' }
        ];

        const COLORS = {
            text: '#ffffff',
            score: '#FFD700',
            life: '#FF6B6B',
            time: '#4ECDC4',
            combo: '#FF69B4',
            rainbow: ['#FF6B6B', '#FECA57', '#48DBFB', '#FF9FF3', '#54A0FF', '#5F27CD']
        };

        const ITEM_TYPES = {
            pizza:   { emoji: 'üçï', score: 10,  probability: 35, speed: 3, color: '#FECA57', size: 'small' },
            fries:   { emoji: 'üçü', score: 15,  probability: 20, speed: 3, color: '#F9CA24', size: 'small' },
            burger:  { emoji: 'üçî', score: 25,  probability: 20, speed: 4, color: '#FF9F43', size: 'medium' },
            chicken: { emoji: 'üçó', score: 40,  probability: 12, speed: 4, color: '#EE5A24', size: 'medium' },
            cake:    { emoji: 'üéÇ', score: 60,  probability: 5,  speed: 5, color: '#FD79A8', size: 'large' },
            star:    { emoji: '‚≠ê', score: 100, probability: 3,  speed: 5, color: '#F9CA24', size: 'special' },
            bomb:    { emoji: 'üí£', score: -1,  probability: 5,  speed: 4, color: '#636E72', size: 'danger' }
        };

        const GRADES = [
            { min: 1000, grade: 'üëë', title: 'Ï†ÑÏÑ§Ïùò ÎåÄÏãùÍ∞Ä', message: 'Î®πÎ∞©Ïùò Ïã†Ïù¥ Í∞ïÎ¶ºÌñàÎã§!', color: '#FFD700' },
            { min: 500, grade: 'ü•á', title: 'Î®πÎ∞© Ïä§ÌÉÄ', message: 'ÎåÄÎã®Ìï¥!', color: '#FFD700' },
            { min: 200, grade: 'ü•à', title: 'Î®πÎ∞© Ïú†ÎßùÏ£º', message: 'Ï†úÎ≤ïÏù∏Îç∞?', color: '#C0C0C0' },
            { min: 0,   grade: 'ü•â', title: 'Î∞∞Í≥†Ìîà Ï¥àÎ≥¥', message: 'Îçî Ïó¥Ïã¨Ìûà Î®πÏñ¥Î≥¥Ïûê!', color: '#CD7F32' }
        ];

        const LEVEL_SCORES = [0, 100, 250, 450, 700];

        // Í≤åÏûÑ ÏÉÅÌÉú Î≥ÄÏàò
        let gameState = 'start';
        let score = 0;
        let life = 3;
        let timeLeft = GAME_TIME;
        let playerX;
        let items = [];
        let particles = [];
        let stars = [];
        let clouds = [];
        let lastSpawnTime = 0;
        let lastSecondTime = 0;
        let rainbowOffset = 0;

        let combo = 0;
        let lastEatTime = 0;
        let comboTimeout = 1500;
        let maxCombo = 0;

        let level = 1;
        let levelUpEffect = 0;
        let showLevelUp = false;

        let startBtn, quitBtn, restartBtn, quitBtnGame;

        // ============================================
        // p5.js Í∏∞Î≥∏ Ìï®Ïàò
        // ============================================

        function setup() {
            let canvas = createCanvas(CANVAS_WIDTH, CANVAS_HEIGHT);
            canvas.parent('game-container');
            textAlign(CENTER, CENTER);
            playerX = width / 2;

            for (let i = 0; i < 30; i++) {
                stars.push({
                    x: random(width),
                    y: random(height),
                    size: random(2, 5),
                    twinkle: random(0.02, 0.08)
                });
            }

            for (let i = 0; i < 5; i++) {
                clouds.push({
                    x: random(width),
                    y: random(50, 200),
                    size: random(40, 80),
                    speed: random(0.2, 0.5)
                });
            }

            startBtn = { x: width/2, y: height/2 + 20, w: 200, h: 60 };
            quitBtn = { x: width/2, y: height/2 + 100, w: 200, h: 50 };
            restartBtn = { x: width/2, y: height - 150, w: 200, h: 60 };
            quitBtnGame = { x: width - 50, y: 25, w: 80, h: 35 };
        }

        function draw() {
            rainbowOffset += 0.02;

            switch(gameState) {
                case 'start':
                    drawStartScreen();
                    break;
                case 'playing':
                    updateGame();
                    drawGame();
                    break;
                case 'gameover':
                    drawGameOverScreen();
                    break;
            }

            updateParticles();
        }

        // ============================================
        // ÌååÌã∞ÌÅ¥ ÏãúÏä§ÌÖú
        // ============================================

        function createParticles(x, y, color, count, type = 'normal') {
            for (let i = 0; i < count; i++) {
                particles.push({
                    x: x, y: y,
                    vx: random(-6, 6),
                    vy: random(-10, -3),
                    size: random(8, 20),
                    color: color,
                    life: 1,
                    decay: random(0.015, 0.04),
                    emoji: type === 'star' ? random(['‚ú®', 'üåü', 'üí´', '‚≠ê']) : random(['‚ú®', 'üåü', 'üí•', 'üí´']),
                    type: type
                });
            }
        }

        function createScorePopup(x, y, points, isCombo = false, comboCount = 0) {
            let displayText = (points > 0 ? '+' : '') + points;
            if (isCombo && comboCount > 1) {
                displayText += ' x' + comboCount + 'ÏΩ§Î≥¥!';
            }

            particles.push({
                x: x, y: y, vx: 0, vy: -3,
                size: isCombo ? 28 : 24,
                color: isCombo ? '#FF69B4' : (points > 0 ? '#FFD700' : '#FF6B6B'),
                life: 1, decay: 0.015,
                text: displayText, isText: true,
                scale: isCombo ? 1.5 : 1
            });
        }

        function createLevelUpEffect() {
            showLevelUp = true;
            levelUpEffect = 60;
            playSound('levelUp');

            for (let i = 0; i < 50; i++) {
                createParticles(random(width), random(height/2), COLORS.rainbow[floor(random(6))], 1, 'star');
            }
        }

        function updateParticles() {
            for (let i = particles.length - 1; i >= 0; i--) {
                let p = particles[i];
                p.x += p.vx;
                p.y += p.vy;
                p.vy += 0.15;
                p.life -= p.decay;
                if (p.life <= 0) particles.splice(i, 1);
            }
        }

        function drawParticles() {
            for (let p of particles) {
                if (p.isText) {
                    textSize(p.size * (p.scale || 1));
                    fill(red(color(p.color)), green(color(p.color)), blue(color(p.color)), p.life * 255);
                    stroke(0, 0, 0, p.life * 100);
                    strokeWeight(3);
                    text(p.text, p.x, p.y);
                    noStroke();
                } else {
                    textSize(p.size * p.life);
                    text(p.emoji, p.x, p.y);
                }
            }
        }

        // ============================================
        // Î∞∞Í≤Ω Í∑∏Î¶¨Í∏∞
        // ============================================

        function drawBrightBackground() {
            let theme = LEVEL_THEMES[min(level - 1, LEVEL_THEMES.length - 1)];

            for (let i = 0; i < height; i++) {
                let inter = map(i, 0, height, 0, 1);
                let c1 = color(theme.bg1);
                let c2 = color(theme.bg2);
                let c3 = color(theme.bg3);
                let c;
                if (inter < 0.5) {
                    c = lerpColor(c1, c2, inter * 2);
                } else {
                    c = lerpColor(c2, c3, (inter - 0.5) * 2);
                }
                stroke(c);
                line(0, i, width, i);
            }

            noStroke();
            for (let cloud of clouds) {
                cloud.x += cloud.speed;
                if (cloud.x > width + cloud.size) cloud.x = -cloud.size;

                fill(255, 255, 255, 200);
                ellipse(cloud.x, cloud.y, cloud.size, cloud.size * 0.6);
                ellipse(cloud.x - cloud.size * 0.3, cloud.y + 5, cloud.size * 0.7, cloud.size * 0.5);
                ellipse(cloud.x + cloud.size * 0.3, cloud.y + 5, cloud.size * 0.7, cloud.size * 0.5);
            }

            for (let star of stars) {
                let brightness = (sin(frameCount * star.twinkle) + 1) / 2;
                fill(255, 255, 200, brightness * 255);
                noStroke();
                push();
                translate(star.x, star.y);
                for (let j = 0; j < 4; j++) {
                    rotate(PI / 4);
                    ellipse(0, 0, star.size * 0.3, star.size);
                }
                pop();
            }
        }

        function drawRainbowBorder() {
            noFill();
            strokeWeight(4);
            for (let i = 0; i < 6; i++) {
                let c = color(COLORS.rainbow[(i + floor(rainbowOffset * 10)) % 6]);
                stroke(red(c), green(c), blue(c), 200);
                rect(i * 2, i * 2, width - i * 4, height - i * 4, 10);
            }
        }

        // ============================================
        // Í≤åÏûÑ Î°úÏßÅ
        // ============================================

        function startGame() {
            gameState = 'playing';
            score = 0;
            life = 3;
            timeLeft = GAME_TIME;
            playerX = width / 2;
            items = [];
            particles = [];
            combo = 0;
            maxCombo = 0;
            level = 1;
            showLevelUp = false;
            lastSpawnTime = millis();
            lastSecondTime = millis();
            lastEatTime = 0;

            playSound('start');
            startBGM();
        }

        function updateGame() {
            let newLevel = 1;
            for (let i = LEVEL_SCORES.length - 1; i >= 0; i--) {
                if (score >= LEVEL_SCORES[i]) {
                    newLevel = i + 1;
                    break;
                }
            }
            if (newLevel > level) {
                level = newLevel;
                createLevelUpEffect();
            }

            if (levelUpEffect > 0) {
                levelUpEffect--;
                if (levelUpEffect === 0) showLevelUp = false;
            }

            if (combo > 0 && millis() - lastEatTime > comboTimeout) {
                combo = 0;
            }

            if (millis() - lastSecondTime >= 1000) {
                timeLeft--;
                lastSecondTime = millis();
                if (timeLeft <= 0) {
                    gameState = 'gameover';
                    stopBGM();
                    playSound('gameOver');
                    createParticles(width/2, height/2, '#FFD700', 40, 'star');
                    return;
                }
            }

            if (keyIsDown(LEFT_ARROW) || keyIsDown(65)) playerX -= PLAYER_SPEED;
            if (keyIsDown(RIGHT_ARROW) || keyIsDown(68)) playerX += PLAYER_SPEED;
            playerX = constrain(playerX, PLAYER_SIZE/2, width - PLAYER_SIZE/2);

            let spawnInterval = SPAWN_INTERVAL_BASE - (level - 1) * 80;
            spawnInterval = max(spawnInterval, 400);

            if (millis() - lastSpawnTime >= spawnInterval) {
                spawnItem();
                lastSpawnTime = millis();
            }

            for (let i = items.length - 1; i >= 0; i--) {
                let item = items[i];
                let speedBonus = 1 + (level - 1) * 0.15;
                item.y += item.speed * speedBonus;
                item.wobble += 0.12;
                item.displayX = item.x + sin(item.wobble) * 8;
                item.rotation += 0.05;

                if (checkCollision(item)) {
                    if (item.type === 'bomb') {
                        life--;
                        combo = 0;
                        playSound('bomb');
                        createParticles(item.displayX, item.y, '#FF6B6B', 20);
                        createScorePopup(item.displayX, item.y, -1);
                        if (life <= 0) {
                            gameState = 'gameover';
                            stopBGM();
                            playSound('gameOver');
                            return;
                        }
                    } else {
                        combo++;
                        lastEatTime = millis();
                        if (combo > maxCombo) maxCombo = combo;

                        let comboMultiplier = 1 + (combo - 1) * 0.2;
                        let earnedScore = floor(item.score * comboMultiplier);
                        score += earnedScore;

                        // ÏÇ¨Ïö¥Îìú Ìö®Í≥º
                        if (item.itemSize === 'special') {
                            playSound('star');
                        } else if (item.itemSize === 'large') {
                            playSound('eatBig');
                        } else {
                            playSound('eat');
                        }

                        if (combo > 1 && combo % 3 === 0) {
                            playSound('combo');
                        }

                        let particleCount = item.itemSize === 'small' ? 8 :
                                           item.itemSize === 'medium' ? 15 :
                                           item.itemSize === 'large' ? 25 : 30;

                        createParticles(item.displayX, item.y, item.color, particleCount,
                            item.itemSize === 'special' ? 'star' : 'normal');
                        createScorePopup(item.displayX, item.y, earnedScore, combo > 1, combo);
                    }
                    items.splice(i, 1);
                    continue;
                }

                if (item.y > height + ITEM_SIZE) items.splice(i, 1);
            }
        }

        function spawnItem() {
            let itemType = getRandomItemType();
            let itemData = ITEM_TYPES[itemType];

            let actualSize = ITEM_SIZE;
            if (itemData.size === 'small') actualSize = ITEM_SIZE * 0.8;
            else if (itemData.size === 'medium') actualSize = ITEM_SIZE;
            else if (itemData.size === 'large') actualSize = ITEM_SIZE * 1.3;
            else if (itemData.size === 'special') actualSize = ITEM_SIZE * 1.4;

            items.push({
                type: itemType,
                emoji: itemData.emoji,
                score: itemData.score,
                speed: itemData.speed,
                color: itemData.color,
                itemSize: itemData.size,
                actualSize: actualSize,
                x: random(ITEM_SIZE, width - ITEM_SIZE),
                displayX: 0,
                y: -ITEM_SIZE,
                wobble: random(TWO_PI),
                rotation: 0
            });
        }

        function getRandomItemType() {
            let rand = random(100);
            let cumulative = 0;
            for (let type in ITEM_TYPES) {
                cumulative += ITEM_TYPES[type].probability;
                if (rand < cumulative) return type;
            }
            return 'pizza';
        }

        function checkCollision(item) {
            let playerLeft = playerX - PLAYER_SIZE/2;
            let playerRight = playerX + PLAYER_SIZE/2;
            let playerTop = height - 100 - PLAYER_SIZE/2;
            let playerBottom = height - 100 + PLAYER_SIZE/2;

            let itemLeft = item.displayX - item.actualSize/2;
            let itemRight = item.displayX + item.actualSize/2;
            let itemTop = item.y - item.actualSize/2;
            let itemBottom = item.y + item.actualSize/2;

            return playerRight > itemLeft && playerLeft < itemRight &&
                   playerBottom > itemTop && playerTop < itemBottom;
        }

        function getGrade() {
            for (let g of GRADES) {
                if (score >= g.min) return g;
            }
            return GRADES[GRADES.length - 1];
        }

        // ============================================
        // ÌôîÎ©¥ Í∑∏Î¶¨Í∏∞
        // ============================================

        function drawStartScreen() {
            drawBrightBackground();
            drawRainbowBorder();

            textSize(45);
            for (let i = 0; i < 8; i++) {
                let x = (frameCount * 0.5 + i * 60) % (width + 100) - 50;
                let y = 80 + sin(frameCount * 0.03 + i) * 25 + i * 55;
                let emojis = ['üçï', 'üçî', 'üçó', 'üçü', 'üå≠', 'üç©', 'üç¶', 'üéÇ'];
                text(emojis[i], x, y);
            }

            textSize(52);
            strokeWeight(4);
            stroke(0, 0, 0, 100);
            for (let i = 0; i < 6; i++) {
                let c = color(COLORS.rainbow[(i + floor(frameCount * 0.1)) % 6]);
                fill(red(c), green(c), blue(c), 150);
                text('üçî Î®πÎ∞© Í≤åÏûÑ üçï', width/2 + i - 3, height/4 + i - 3);
            }
            noStroke();
            fill(255);
            text('üçî Î®πÎ∞© Í≤åÏûÑ üçï', width/2, height/4);

            textSize(18);
            fill(80);
            text('ÏùåÏãùÏùÑ Î®πÍ≥† Ìè≠ÌÉÑÏùÑ ÌîºÌï¥Îùº!', width/2, height/4 + 60);

            drawFancyButton('üéÆ Í≤åÏûÑ ÏãúÏûë', startBtn.x, startBtn.y, startBtn.w, startBtn.h, '#4ECDC4', '#26DE81');
            drawFancyButton('üö™ Ï¢ÖÎ£å', quitBtn.x, quitBtn.y, quitBtn.w, quitBtn.h, '#FF6B6B', '#EE5A24');

            textSize(16);
            fill(80);
            text('‚Üê ‚Üí Î∞©Ìñ•ÌÇ§ ÎòêÎäî A D ÌÇ§Î°ú Ïù¥Îèô', width/2, height - 100);
            text('üéµ üîä Î≤ÑÌäºÏúºÎ°ú ÏùåÏïÖ/Ìö®Í≥ºÏùå ON/OFF', width/2, height - 75);

            textSize(13);
            fill(100);
            text('üçï+10  üçü+15  üçî+25  üçó+40  üéÇ+60  ‚≠ê+100', width/2, height - 45);
            text('üí£ÏúÑÌóò!  |  ÏΩ§Î≥¥Î°ú Ï∂îÍ∞Ä Ï†êÏàò!', width/2, height - 25);
        }

        function drawFancyButton(label, x, y, w, h, color1, color2) {
            noStroke();
            fill(0, 0, 0, 80);
            rect(x - w/2 + 4, y - h/2 + 4, w, h, 20);

            let hovered = mouseX > x - w/2 && mouseX < x + w/2 &&
                         mouseY > y - h/2 && mouseY < y + h/2;

            let c1 = color(color1);
            let c2 = color(color2);

            if (hovered) {
                c1 = lerpColor(c1, color(255), 0.3);
                c2 = lerpColor(c2, color(255), 0.3);
            }

            for (let i = 0; i < h; i++) {
                let inter = map(i, 0, h, 0, 1);
                let c = lerpColor(c1, c2, inter);
                stroke(c);
                line(x - w/2 + 10, y - h/2 + i, x + w/2 - 10, y - h/2 + i);
            }

            noFill();
            stroke(255, 255, 255, 200);
            strokeWeight(3);
            rect(x - w/2, y - h/2, w, h, 20);

            noStroke();
            fill(255);
            textSize(h * 0.4);
            text(label, x, y);

            if (hovered) {
                fill(255, 255, 255, 120 + sin(frameCount * 0.2) * 60);
                noStroke();
                rect(x - w/2 + 5, y - h/2 + 5, w - 10, h/3, 15);
            }
        }

        function drawGame() {
            drawBrightBackground();

            let theme = LEVEL_THEMES[min(level - 1, LEVEL_THEMES.length - 1)];

            for (let i = 0; i < 60; i++) {
                let inter = map(i, 0, 60, 0, 1);
                let groundColor = lerpColor(color(theme.ground), color(100, 200, 100), inter * 0.3);
                stroke(groundColor);
                line(0, height - 60 + i, width, height - 60 + i);
            }

            stroke(255, 255, 255, 100);
            strokeWeight(3);
            line(0, height - 60, width, height - 60);

            for (let item of items) {
                fill(0, 0, 0, 80);
                noStroke();
                ellipse(item.displayX + 3, item.y + 3, item.actualSize * 0.7);

                let glowColor = color(item.color);
                fill(red(glowColor), green(glowColor), blue(glowColor), 100);
                ellipse(item.displayX, item.y, item.actualSize * 1.2);

                push();
                translate(item.displayX, item.y);
                rotate(sin(item.wobble) * 0.15);
                textSize(item.actualSize);
                text(item.emoji, 0, 0);
                pop();
            }

            drawPlayer();
            drawHUD();
            drawParticles();

            if (showLevelUp) drawLevelUpText();
        }

        function drawPlayer() {
            fill(0, 0, 0, 80);
            noStroke();
            ellipse(playerX + 4, height - 96, PLAYER_SIZE * 0.7);

            fill(255, 220, 100, 100);
            ellipse(playerX, height - 100, PLAYER_SIZE * 1.3);

            textSize(PLAYER_SIZE);
            text('üòã', playerX, height - 100);

            for (let i = 0; i < 15; i++) {
                let inter = map(i, 0, 15, 0, 1);
                let c = lerpColor(color('#6C5CE7'), color('#A29BFE'), inter);
                fill(c);
                noStroke();
                rect(playerX - 40 + i * 0.5, height - 60 + i, 80 - i, 3, 5);
            }

            fill(255, 255, 255, 150);
            rect(playerX - 35, height - 60, 70, 4, 3);
        }

        function drawHUD() {
            noStroke();
            fill(255, 255, 255, 180);
            rect(0, 0, width, 70, 0, 0, 15, 15);

            fill(0, 0, 0, 30);
            rect(0, 65, width, 5);

            textSize(18);
            noStroke();

            let timeColor = timeLeft > 10 ? color('#2ECC71') : color('#E74C3C');
            if (timeLeft <= 10) {
                timeColor = lerpColor(color('#E74C3C'), color('#F39C12'), (sin(frameCount * 0.3) + 1) / 2);
            }
            fill(timeColor);
            textAlign(LEFT, CENTER);
            text('‚è±Ô∏è ' + timeLeft + 'Ï¥à', 15, 22);

            let theme = LEVEL_THEMES[min(level - 1, LEVEL_THEMES.length - 1)];
            fill(100);
            textSize(14);
            text('Lv.' + level + ' ' + theme.name, 15, 48);

            fill('#E67E22');
            textAlign(CENTER, CENTER);
            textSize(22);
            text('üèÜ ' + score + 'Ï†ê', width/2, 22);

            if (combo > 1) {
                let comboScale = 1 + sin(frameCount * 0.3) * 0.1;
                textSize(16 * comboScale);
                fill('#E91E63');
                text('üî• ' + combo + ' COMBO!', width/2, 48);
            }

            textSize(20);
            fill('#E74C3C');
            textAlign(RIGHT, CENTER);
            let hearts = '';
            for (let i = 0; i < 3; i++) hearts += i < life ? '‚ù§Ô∏è' : 'üñ§';
            text(hearts, width - 60, 35);

            drawSmallButton('‚úï', quitBtnGame.x, quitBtnGame.y, 40, 30);
        }

        function drawSmallButton(label, x, y, w, h) {
            let hovered = mouseX > x - w/2 && mouseX < x + w/2 &&
                         mouseY > y - h/2 && mouseY < y + h/2;

            fill(hovered ? color(255, 100, 100, 230) : color(150, 150, 150, 200));
            noStroke();
            rect(x - w/2, y - h/2, w, h, 8);

            fill(255);
            textAlign(CENTER, CENTER);
            textSize(16);
            text(label, x, y);
        }

        function drawLevelUpText() {
            let alpha = map(levelUpEffect, 0, 60, 0, 255);
            let scale = map(levelUpEffect, 0, 60, 0.5, 1.5);

            textAlign(CENTER, CENTER);

            for (let i = 5; i > 0; i--) {
                fill(255, 215, 0, alpha * 0.3);
                textSize(50 * scale + i * 5);
                text('üéâ LEVEL UP! üéâ', width/2, height/2);
            }

            fill(255, 255, 255, alpha);
            textSize(50 * scale);
            text('üéâ LEVEL UP! üéâ', width/2, height/2);

            let theme = LEVEL_THEMES[min(level - 1, LEVEL_THEMES.length - 1)];
            textSize(24);
            fill(255, 255, 0, alpha);
            text('Level ' + level + ': ' + theme.name, width/2, height/2 + 50);
        }

        function drawGameOverScreen() {
            drawBrightBackground();

            fill(0, 0, 0, 150);
            rect(0, 0, width, height);

            if (frameCount % 8 === 0) {
                createParticles(random(width), random(height/2), COLORS.rainbow[floor(random(6))], 2, 'star');
            }
            drawParticles();

            let grade = getGrade();

            textAlign(CENTER, CENTER);
            textSize(40);
            stroke(0, 0, 0, 150);
            strokeWeight(4);
            fill(255, 150, 150);
            text('GAME OVER', width/2, height/8);
            noStroke();

            let gradeScale = 1 + sin(frameCount * 0.1) * 0.1;
            textSize(70 * gradeScale);
            text(grade.grade, width/2, height/4 + 20);

            textSize(26);
            fill(grade.color);
            text(grade.title, width/2, height/3 + 30);

            textSize(22);
            fill(255);
            text('ÏµúÏ¢Ö Ï†êÏàò: ' + score + 'Ï†ê', width/2, height/2 - 20);

            textSize(18);
            fill('#FF69B4');
            text('ÏµúÍ≥† ÏΩ§Î≥¥: ' + maxCombo + ' COMBO', width/2, height/2 + 10);

            fill('#4ECDC4');
            text('ÎèÑÎã¨ Î†àÎ≤®: Lv.' + level, width/2, height/2 + 35);

            textSize(16);
            fill(220);
            text('"' + grade.message + '"', width/2, height/2 + 70);

            drawFancyButton('üîÑ Îã§Ïãú ÌïòÍ∏∞', restartBtn.x, restartBtn.y, restartBtn.w, restartBtn.h, '#4ECDC4', '#26DE81');
            drawFancyButton('üö™ Ï¢ÖÎ£å', width/2, height - 80, 200, 50, '#FF6B6B', '#EE5A24');

            textSize(14);
            fill(180);
            text('SPACE ÎòêÎäî Î≤ÑÌäº ÌÅ¥Î¶≠', width/2, height - 35);
        }

        // ============================================
        // ÏûÖÎ†• Ï≤òÎ¶¨
        // ============================================

        function keyPressed() {
            if (key === ' ') handleStart();
            if (key === 'Escape' || key === 'q' || key === 'Q') {
                if (gameState === 'playing') {
                    gameState = 'start';
                    stopBGM();
                }
            }
            if (key === 'm' || key === 'M') toggleBGM();
            if (key === 'n' || key === 'N') toggleSFX();
        }

        function mousePressed() {
            // Ïò§ÎîîÏò§ Ï¥àÍ∏∞Ìôî (Ï≤´ ÌÅ¥Î¶≠ Ïãú)
            initAudio();

            if (gameState === 'start') {
                if (isInsideButton(startBtn)) {
                    startGame();
                    return;
                }
                if (isInsideButton(quitBtn)) {
                    window.close();
                    return;
                }
            }
            else if (gameState === 'playing') {
                if (isInsideButton(quitBtnGame)) {
                    gameState = 'start';
                    stopBGM();
                    return;
                }
            }
            else if (gameState === 'gameover') {
                if (isInsideButton(restartBtn)) {
                    startGame();
                    return;
                }
                if (mouseX > width/2 - 100 && mouseX < width/2 + 100 &&
                    mouseY > height - 105 && mouseY < height - 55) {
                    gameState = 'start';
                    return;
                }
            }

            handleStart();
        }

        function isInsideButton(btn) {
            return mouseX > btn.x - btn.w/2 && mouseX < btn.x + btn.w/2 &&
                   mouseY > btn.y - btn.h/2 && mouseY < btn.y + btn.h/2;
        }

        function handleStart() {
            if (gameState === 'start' || gameState === 'gameover') {
                if (gameState === 'start') {
                    if (!isInsideButton(quitBtn)) startGame();
                } else {
                    startGame();
                }
            }
        }
    </script>
</body>
</html>
